get_extract_data <- function(my_query) {
  
  #print(is.numeric(my_query))
  splittedQuery <- strsplit(my_query, " +")
  
  print(my_query)
  #my_query2 <- "34257155 34381732 34478639 34890276 34478639 34907918 21164044 32039007 20508200 24280772 28196513 24507759 22490780 28513999 21697458 21188461 33191545 26950237 26499398 31178859 29262323 26935289 27221966 27273849 26868913 28031477 22981536 24952504 29466759 34359844 20595650 19689743 32524751 32434457 24816404 32691408 29363526 35222361 23825232 32411122 35174225 28158426 26825554 31941367 32811295 30775441 31704966 31043745 32427863 31160207 32589830 28416795 20727130 32456225 32988843 29669944 32321113 33529160 31181324 31030361 31451099 29785656 30504842 34638757 31649677 31906243 33306983 19380816 26826241 19941314 28417112 29123954 33897370 29956819 34203451 32000895 22025564 29211299 17603493 24907113 19572148 28108766 31557313 34739715 20028852 32903466 16186186 19201693 15313928 17023580 28978469 25771792 30684003 24259296 27558327 27050283 33160842 25616107 34590328 25544757 30482226 31078776 22043967 33711331 34858398 34066647 29426702 29410668 31327964 33052221 28602351 33352944 33198789 31416451 33836143 22937006 34884842 33337366 31824510 32592865 28723550 24885259 28070266 27466354 24825127 32331368 32941599 31257985 33915751 33746988 33919154 31092713 31754705 32155954 29079455 30129188 26125102 32772131 31754025 27241241 20439745 19925669 19818098 26451323 33202783 28580927 21753152 25955018 30455381 29399399 35197103 32453761 26980746 29748013 25941621 26635802 28487310 32209603 25931994 30107552 24942685 33466682 27243593 31963519 26080709 33359089 32652144 30927978 32942172 34633041 35371619 28712928 35082159 33537747 31572379 29324769 25490065 27664279 26838049 19371737 26215868 19429472 24052949 34301813 21106641 21190185 22733995 27487182 19667062 33414787 30622307 24657523 35046083 28541408 32103293 32092078 23589610 27391078 30012671 26982806 26626346 30408584 32621844 27567245 34990621 30392911 33790898 30455703 30487795 32510170 29967068 31755523 34262760 32793228 27999744 25996397 34620838 34413168 28718445 34230649 26647392 31293583 28417112 28638730 30121453 26475869 33906865 34348160 27102489 29241546 35003081 26970376 30262472 29147615 28264904 24501019 25620698 19732719 24092389 35269405 34680231 30003321 22348096 34974960 31957112 29851227 31160207 26619320 33046971 26319316 29904979 29490633 33285051 27609109 24957319 30895168 21685373 33239427 33963274 32508825 31616408 33919875 33741967 25274726 33283987 34140316 27783948 27037906 26348470 23202296 32493990 34620838 33446416 33848267 31611651 26967390 15551798 32045384 32453713 27529074 31546668 34578386 29904979 33542131"
  
  #Get all pmids
  res <- get_pubmed_ids(my_query)
  print("Work")
  
  #runjs("console.log('After query 1')")
  
  test <- paste("https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?",
                "db=pubmed&&term=", res$OriginalQuery, "&usehistory=n&retmax=100000", sep = "")
  
  #runjs("console.log('After query 2')")
  
  res_url <- url(test,open="rb", encoding = "UTF8")
  on.exit(close(res_url))
  idXML <- readLines(res_url, warn = FALSE, encoding = "UTF8")
  collect_ids <- list()
  for (i in 1:length(idXML)) {
    if (grepl("^(\\t){0,1}<Id>", idXML[i])) {
      xx <- custom_grep(idXML[i], tag = "Id", format = "char")
      collect_ids[[length(collect_ids) + 1]] <- as.character(xx[1])
    }
  }
  myIDlist <- as.character(do.call(c, collect_ids))
  #myIDlist <- "21565215 23518347 22277903 31629410 25035953 25035950 12354377 35364740 30483809 29482836 32161718 34566965 31849950 19383967 16527895 11200064 29176984 35133977 31947581 32498431 31300030 28428369 33545035 19320568 27909056 28122869 27922067 27905985 34331874 32723919 23269793 35396971 29703719 29478771 29478771 32461350 32943450 32461350 34442004 32294293 29895501 31333653 28825141 32857321 30476564 19341823 27841856 34381461 16322748 20193028 27869795 23974993 23873152 25479725 31646402 22861366 30400975 27620506 33729699 23352235 29959183 17446082 33473192 16818757 31063541 30584238 26717325 33526926 28297581 26610284 32138314 11927927 32414695 30569204 23460749 19936055 32907925 35048638 25931043 12553699 21413455 16720036 27546361 34248984 33759145 34788598 23686490 20570887 33361391 34960815 21442393 34445367 34579743 32246014 29033131 30930171 28923935 29950315 26573801 31727856 27525438 33836585 27197074 27357636 25008481 33054050 33672737 29437577 15919883 29261815 30542349 34773892 27421871 33813036 28273887 24963213 28263993 33037057 23273921 31718550 32230977 33051339 31312042 27243595 32693188 34343272 27130484 35177618 34134627 33566377 31061532 9389474 22005520 20303596 19922425 32599709 26671426 31497026 27851925 33014656 31713700 31372765 26764486 28432199 28050750 29515586 10879693 31290914 27213956 31209404 31409426 33296655 28556560 22178414 28586276 32117255 28865088 31333642 24166242 17869134 32810438 31754025 32157175 31456804 33015602 35372996 33183319 31501122 34659254 30649988 30357490 33293219 32071090 31474513 31472079 28930664 25033907 28774715  21214520 30842629 31089324 30760015 29069365 32841051 21153665 21888931 20133793 23296408 19301037 26538820 34140953 34206393 34440315 34827560 35204748 31090259 33717163 35300986 34279540 34965966 30641038 25901897 34860431 22777876 35401514 35406483 29750788 33767694 35185880 24626392 26484769 28835242 29906450 32610077 30953118 29504948 35089436 32979832 31184711 25962123 35000202 30179225 33607496 31474513 28783692 30996346 29348500 30323345 31467405 34135508 34239777 27888810 29961579 28143882 31365858 32783915 21943488 30827862 34965415 6862689 31903134 35241835 20424161 34637400 11777962 32269279 17114237 17545580 22685580 29988129 87267 6765335 24612598 35325594 24220244 31178859 29616851 22786767 28677265 32733446 35181780 6971808 16556895 33266104 15879104 27976373 33641866 28837503 26718149 27446090 22268650 15905489 22041852 26069306 17429444 30530726 27194625 29466759 25481369 23332516 25107306 32209459 30528823 29180488 28592561 28958578 33492309 34672126 23143594 33888321 34303522 34000757 34903717 32282893 32763266 33135636 31221993 35199642 31086329 34233045 30518920 33805777 31786670 31473081 34514433 34299338 34524838 34312415 33425431 33815385 34282331 33098771 28916263 26109679 26198639 35279880 31024570 25545227 31616403 22542839 25279834 31242422 34887574 19609975 34257155 34381732 34478639 34890276 34478639 34907918 21164044 32039007 20508200 24280772 28196513 24507759 22490780 28513999 21697458 21188461 33191545 26950237 26499398 31178859 29262323 26935289 27221966 27273849 26868913 28031477 22981536 24952504 29466759 34359844 20595650 19689743 32524751 32434457 24816404 32691408 29363526 35222361 23825232 32411122 35174225 28158426 26825554 31941367 32811295 30775441 31704966 31043745 32427863 31160207 32589830 28416795 20727130 32456225 32988843 29669944 32321113 33529160 31181324 31030361 31451099 29785656 30504842 34638757 31649677 31906243 33306983 19380816 26826241 19941314 28417112 29123954 33897370 29956819 34203451 32000895 22025564 29211299 17603493 24907113 19572148 28108766 31557313 34739715 20028852 32903466 16186186 19201693 15313928 17023580 28978469 25771792 30684003 24259296 27558327 27050283 33160842 25616107 34590328 25544757 30482226 31078776 22043967 33711331 34858398 34066647 29426702 29410668 31327964 33052221 28602351 33352944 33198789 31416451 33836143 22937006 34884842 33337366 31824510 32592865 28723550 24885259 28070266 27466354 24825127 32331368 32941599 31257985 33915751 33746988 33919154 31092713 31754705 32155954 29079455 30129188 26125102 32772131 31754025 27241241 20439745 19925669 19818098 26451323 33202783 28580927 21753152 25955018 30455381 29399399 35197103 32453761 26980746 29748013 25941621 26635802 28487310 32209603 25931994 30107552 24942685 33466682 27243593 31963519 26080709 33359089 32652144 30927978 32942172 34633041 35371619 28712928 35082159 33537747 31572379 29324769 25490065 27664279 26838049 19371737 26215868 19429472 24052949 34301813 21106641 21190185 22733995 27487182 19667062 33414787 30622307 24657523 35046083 28541408 32103293 32092078 23589610 27391078 30012671 26982806 26626346 30408584 32621844 27567245 34990621 30392911 33790898 30455703 30487795 32510170 29967068 31755523 34262760 32793228 27999744 25996397 34620838 34413168 28718445 34230649 26647392 31293583 28417112 28638730 30121453 26475869 33906865 34348160 27102489 29241546 35003081 26970376 30262472 29147615 28264904 24501019 25620698 19732719 24092389 35269405 34680231 30003321 22348096 34974960 31957112 29851227 31160207 26619320 33046971 26319316 29904979 29490633 33285051 27609109 24957319 30895168 21685373 33239427 33963274 32508825 31616408 33919875 33741967 25274726 33283987 34140316 27783948 27037906 26348470 23202296 32493990 34620838 33446416 33848267 31611651 26967390 15551798 32045384 32453713 27529074 31546668 34578386 29904979 33542131"
  #print(length(myIDlist))
  
  
  #Connect and get from extract db
  con <- dbConnect(RMySQL::MySQL(), dbname = "extract", user="theodos", password="89Lilu#1")
  #df <- dbGetQuery(conn = con, paste("SELECT * FROM EntityWords WHERE pmid IN (",toString(myIDlist),")")) %>% group_by(PMID) %>% summarize(Type=paste(EntityType, collapse="."), New=paste(Word, collapse="."),  Id=paste(ID, collapse=".")) %>% rename(pmid=PMID)
  allData <- dbGetQuery(conn = con, paste("SELECT * FROM EntityWords WHERE pmid IN (",toString(myIDlist),")"))
  #allData <- dbGetQuery(conn = con, paste("SELECT * FROM EntityWords WHERE pmid IN ('21565215 23518347 22277903 31629410 25035953 25035950 12354377 35364740 30483809 29482836 32161718 34566965 31849950 19383967 16527895 11200064 29176984 35133977 31947581 32498431 31300030 28428369 33545035 19320568 27909056 28122869 27922067 27905985 34331874 32723919 23269793 35396971 29703719 29478771 29478771 32461350 32943450 32461350 34442004 32294293 29895501 31333653 28825141 32857321 30476564 19341823 27841856 34381461 16322748 20193028 27869795 23974993 23873152 25479725 31646402 22861366 30400975 27620506 33729699 23352235 29959183 17446082 33473192 16818757 31063541 30584238 26717325 33526926 28297581 26610284 32138314 11927927 32414695 30569204 23460749 19936055 32907925 35048638 25931043 12553699 21413455 16720036 27546361 34248984 33759145 34788598 23686490 20570887 33361391 34960815 21442393 34445367 34579743 32246014 29033131 30930171 28923935 29950315 26573801 31727856 27525438 33836585 27197074 27357636 25008481 33054050 33672737 29437577 15919883 29261815 30542349 34773892 27421871 33813036 28273887 24963213 28263993 33037057 23273921 31718550 32230977 33051339 31312042 27243595 32693188 34343272 27130484 35177618 34134627 33566377 31061532 9389474 22005520 20303596 19922425 32599709 26671426 31497026 27851925 33014656 31713700 31372765 26764486 28432199 28050750 29515586 10879693 31290914 27213956 31209404 31409426 33296655 28556560 22178414 28586276 32117255 28865088 31333642 24166242 17869134 32810438 31754025 32157175 31456804 33015602 35372996 33183319 31501122 34659254 30649988 30357490 33293219 32071090 31474513 31472079 28930664 25033907 28774715  21214520 30842629 31089324 30760015 29069365 32841051 21153665 21888931 20133793 23296408 19301037 26538820 34140953 34206393 34440315 34827560 35204748 31090259 33717163 35300986 34279540 34965966 30641038 25901897 34860431 22777876 35401514 35406483 29750788 33767694 35185880 24626392 26484769 28835242 29906450 32610077 30953118 29504948 35089436 32979832 31184711 25962123 35000202 30179225 33607496 31474513 28783692 30996346 29348500 30323345 31467405 34135508 34239777 27888810 29961579 28143882 31365858 32783915 21943488 30827862 34965415 6862689 31903134 35241835 20424161 34637400 11777962 32269279 17114237 17545580 22685580 29988129 87267 6765335 24612598 35325594 24220244 31178859 29616851 22786767 28677265 32733446 35181780 6971808 16556895 33266104 15879104 27976373 33641866 28837503 26718149 27446090 22268650 15905489 22041852 26069306 17429444 30530726 27194625 29466759 25481369 23332516 25107306 32209459 30528823 29180488 28592561 28958578 33492309 34672126 23143594 33888321 34303522 34000757 34903717 32282893 32763266 33135636 31221993 35199642 31086329 34233045 30518920 33805777 31786670 31473081 34514433 34299338 34524838 34312415 33425431 33815385 34282331 33098771 28916263 26109679 26198639 35279880 31024570 25545227 31616403 22542839 25279834 31242422 34887574 19609975 34257155 34381732 34478639 34890276 34478639 34907918 21164044 32039007 20508200 24280772 28196513 24507759 22490780 28513999 21697458 21188461 33191545 26950237 26499398 31178859 29262323 26935289 27221966 27273849 26868913 28031477 22981536 24952504 29466759 34359844 20595650 19689743 32524751 32434457 24816404 32691408 29363526 35222361 23825232 32411122 35174225 28158426 26825554 31941367 32811295 30775441 31704966 31043745 32427863 31160207 32589830 28416795 20727130 32456225 32988843 29669944 32321113 33529160 31181324 31030361 31451099 29785656 30504842 34638757 31649677 31906243 33306983 19380816 26826241 19941314 28417112 29123954 33897370 29956819 34203451 32000895 22025564 29211299 17603493 24907113 19572148 28108766 31557313 34739715 20028852 32903466 16186186 19201693 15313928 17023580 28978469 25771792 30684003 24259296 27558327 27050283 33160842 25616107 34590328 25544757 30482226 31078776 22043967 33711331 34858398 34066647 29426702 29410668 31327964 33052221 28602351 33352944 33198789 31416451 33836143 22937006 34884842 33337366 31824510 32592865 28723550 24885259 28070266 27466354 24825127 32331368 32941599 31257985 33915751 33746988 33919154 31092713 31754705 32155954 29079455 30129188 26125102 32772131 31754025 27241241 20439745 19925669 19818098 26451323 33202783 28580927 21753152 25955018 30455381 29399399 35197103 32453761 26980746 29748013 25941621 26635802 28487310 32209603 25931994 30107552 24942685 33466682 27243593 31963519 26080709 33359089 32652144 30927978 32942172 34633041 35371619 28712928 35082159 33537747 31572379 29324769 25490065 27664279 26838049 19371737 26215868 19429472 24052949 34301813 21106641 21190185 22733995 27487182 19667062 33414787 30622307 24657523 35046083 28541408 32103293 32092078 23589610 27391078 30012671 26982806 26626346 30408584 32621844 27567245 34990621 30392911 33790898 30455703 30487795 32510170 29967068 31755523 34262760 32793228 27999744 25996397 34620838 34413168 28718445 34230649 26647392 31293583 28417112 28638730 30121453 26475869 33906865 34348160 27102489 29241546 35003081 26970376 30262472 29147615 28264904 24501019 25620698 19732719 24092389 35269405 34680231 30003321 22348096 34974960 31957112 29851227 31160207 26619320 33046971 26319316 29904979 29490633 33285051 27609109 24957319 30895168 21685373 33239427 33963274 32508825 31616408 33919875 33741967 25274726 33283987 34140316 27783948 27037906 26348470 23202296 32493990 34620838 33446416 33848267 31611651 26967390 15551798 32045384 32453713 27529074 31546668 34578386 29904979 33542131')"))
  print(colnames(allData))
  
  #Get Word-Type
  wordTypeTable <- allData[, c('Word', 'EntityType')]
  #print(wordTypeTable)
  
  #Format allData for clusternig etc
  df <- allData %>% group_by(PMID) %>% summarize(Type=paste(EntityType, collapse="."), New=paste(Word, collapse="."),  Id=paste(ID, collapse=".")) %>% rename(pmid=PMID)
  print(df)
  
  #Get one column df$columnName
  #extract_corpus <- corpus(df, text_field='New', docid_field = 'pmid')
  extract_corpus <- corpus(df, text_field='New', docid_field = 'pmid')
  corpus_tokens <- extract_corpus %>% tokenize_regex(pattern = "\\.")
  articles_dfm <- dfm(tokens(corpus_tokens))
  print(typeof(articles_dfm))
  #articles_dfm <- dfm(extract_corpus)
  #print('Articles dfm')
  #print(colSums(articles_dfm))
  
  #Change column names for term- frequency table
  sumVec <- colSums(articles_dfm)
  termFreq <- data.table::as.data.table(sumVec, keep.rownames = TRUE)
  colnames(termFreq) <- c('Term', 'Frequency')
  
  results <- list()
  #results$articles_corpus <- articles_corpus
  #results$corpus_tokens <- corpus_tokens
  results$articles_dfm <- articles_dfm
  results$term_frequency <- termFreq
  results$wordTypeTb <- wordTypeTable
  
  return(results)
}



killDbConnections <- function () {
  
  all_cons <- dbListConnections(MySQL())
  
  print(all_cons)
  
  for(con in all_cons)
    +  dbDisconnect(con)
  
  print(paste(length(all_cons), " connections killed."))
  
}

killDbConnections()

#DFM to Igraph
res<-get_extract_data("pavlopoulos g [AU]")

source('calculate_dist_sim.R')
cosDist <- calculate_dist_sim(res$articles_dfm)
#cosDist <- textstat_simil(res$articles_dfm, margin = "documents", method = "cosine")
print(head(cosDist))
articlesIgraph <- graph_from_data_frame(cosDist, vertices=NULL, directed=FALSE)
print(articlesIgraph)

#Louvain
resultsLouvain <-cluster_louvain(articlesIgraph, weights = NULL, resolution = 1)

# communities(resultsLouvain)$"1"
# sizes(resultsLouvain)
# membership(resultsLouvain)
# louvainDf <- data.frame(sort(membership(resultsLouvain)))
# colnames(louvainDf) <- c('pmid', 'cluster')
# print(ncol(louvainDf))

#create df, Should be done better

pmid <- c()
counter <- 1
cluster <- c()
for (comn in communities(resultsLouvain)) {

  for (id in comn) {
    pmid <- append(pmid, id)
    cluster <- append(cluster, counter)
  }
  counter <- counter+1
}

results <- list()
#results$model <- resultsLouvain
results$df <- tibble(pmid, cluster)
colnames(results$df) <- c("pmid","cluster")
print(ncol(results$df))
print(results$df)

#Louvain plotted communities

plot(
  resultsLouvain,
  articlesIgraph,
  col = membership(resultsLouvain),
  mark.groups = communities(resultsLouvain),
  edge.color = c("black", "red")#[crossing(resultsLouvain, articlesIgraph) + 1]
)

#MCL
resultsMCL <- mcl(x = articlesIgraph, addLoops=FALSE)

docnames(articlesIgraph)
print(resultsMCL$Cluster)
results$df <- tibble(pmid, resultsMCL$Cluster)
membership(resultsMCL)

#MCL (Default)
mcl_clustering <- function(dfm, clustering_param, dist_sim_param) {
  # Calculate distance/similarity similarity
  dist_sim <- calculate_dist_sim(dfm, metric = dist_sim_param) #ΑΥΤΟ ΘΕΛΩ ΓΙΑ ΤΟ IGRAPH με μετατροπές
  mcl_model <- mcl(dist_sim, inflation = clustering_param, max.iter = 1000, 
                   addLoops = FALSE)
  
  relabeled_clusters <- factor(mcl_model$Cluster,labels = c(1:length(unique(mcl_model$Cluster))))
  
  
  df_results <- data.frame("pmid" = docnames(dfm), "cluster" = relabeled_clusters)
  # debugging
  #print(mcl_model$Cluster)
  results <- list()
  results$model <- mcl_model
  results$df <- df_results
  
  return(results)
}

mcl_clustering(res$articles_dfm, 2.2, "cosine")

#Kmeans (Standard)
kmeans_clustering <- function(dfm, clustering_param) {
  km_out <- stats::kmeans(dfm, centers = clustering_param ) #Εδώ πεθαίνει η extract/ Εκτός αν ανοίξω τα advanced και δούλεψε;;;Πιθανώς κάτι με το switch (input$clustering_param)

  colnames(km_out$centers) <- featnames(dfm)

  df_clustering <- broom::augment(km_out, data = convert(dfm, to="data.frame"))
  print(df_clustering)

  df_clustering_trun <- df_clustering %>% select(doc_id,.cluster)

  colnames(df_clustering_trun) <- c("pmid","cluster") #OLD

  results <- list()
  results$model <- km_out
  results$df <- df_clustering_trun #OLD
  #results$df <- df_clustering #ME

  return(results)
}

kmeansOut <- kmeans_clustering(res$articles_dfm, 2)
print(kmeansOut$df)
print(ncol(kmeansOut$df))

#################
source('get_pubmed_data.R')
source('make_dfm.R')
source('make_clustering.R')
source('functionaly_annotate_clusters.R')
#source('trimBy_TfIdf.R')
source('testExtract2.R')
source('handle_long_extract.R')

extractResults <- get_extract_data("pavlopoulos g [AU]")
runjs("console.log('It is below 200 ids')")


runjs("document.getElementById('myBar').style.width = '20%';")  

#Για την extract βάζω τον πίνακα με το colsum όπως είναι
colnames(extractResults$term_frequency)[which(names(extractResults$term_frequency) == "term_frequency")] #<- "newColName"

runjs("console.log('After Biomed')")
allResults <- list()

allResults$article_dfm_forClustering <- extractResults$articles_dfm
allResults$articles_dfm <- extractResults$term_frequency
allResults$wordTypeTb <- extractResults$wordTypeTb #this can be omitted/used directly

print(allResults$article_dfm_forClustering)
#Run the clustering from above
 

#Louvain
source('calculate_dist_sim.R')
cosDist <- calculate_dist_sim(allResults$article_dfm_forClustering)
#cosDist <- textstat_simil(res$articles_dfm, margin = "documents", method = "cosine")
print(head(cosDist))
print(nrow(cosDist))
articlesIgraph <- graph_from_data_frame(cosDist, vertices=NULL, directed=FALSE)
print(articlesIgraph)

#Louvain
resultsLouvain <-cluster_louvain(articlesIgraph, weights = NULL, resolution = 1)

# communities(resultsLouvain)$"1"
# sizes(resultsLouvain)
length(membership(resultsLouvain))
# louvainDf <- data.frame(sort(membership(resultsLouvain)))
# colnames(louvainDf) <- c('pmid', 'cluster')
# print(ncol(louvainDf))

#create df, Should be done better

pmid <- c()
counter <- 1
cluster <- c()
for (comn in communities(resultsLouvain)) {
  
  for (id in comn) {
    pmid <- append(pmid, id)
    cluster <- append(cluster, counter)
  }
  counter <- counter+1
}

results <- list()
#results$model <- resultsLouvain
results$df <- tibble(pmid, cluster)
colnames(results$df) <- c("pmid","cluster")
print(ncol(results$df))
print(results$df)
#Louvain
clustering_results <- results$df

#Create wordcloud
var <- allResults$article_dfm_forClustering %>% dfm_weight()
groups <- clustering_results$cluster
print(nrow(var))
print(allResults$article_dfm_forClustering)
print(length(groups))
pmids <-  clustering_results$pmid
print(pmids)
names <- docnames(allResults$article_dfm_forClustering)
print(names[0])

# for-loop over rows
docIds <- docnames(allResults$article_dfm_forClustering)
idsToRemove <- c()
for(i in 1:length(docIds)) {
  if (!(docIds[i] %in% clustering_results$pmid)){
    idsToREmove <- append(idsToREmove, i)
    print(i)
  }
}
new <- allResults$article_dfm_forClustering[-idsToRemove,]
print(nrow(new))
print(nrow( allResults$article_dfm_forClustering))

trimmedDFm <-new
trimmedDFm <- dfm_subset(allResults$article_dfm_forClustering, clustering_results$pmid, drop_docid=TRUE)
print(trimmedDFm)
freq <- textstat_frequency(trimmedDFm %>% dfm_weight(), n=1, groups = clustering_results$cluster)
print(freq)

output$tagcloud_plot <- renderPlot({
  #session$sendCustomMessage(type = "wordType", allResults$wordTypeTb)
  runjs("console.log('In render plot')")
  session$sendCustomMessage(type = "Handler", textstat_frequency(allResults$article_dfm_forClustering %>% dfm_weight(), n=50, groups = clustering_results$cluster))
  runjs("console.log('Custom message sent')")
  runjs("for (var cluster of allClusters) {buildWordcloud(cluster)}")
  
})

#Louvain plotted communities

plot(
  resultsLouvain,
  articlesIgraph,
  col = membership(resultsLouvain),
  mark.groups = communities(resultsLouvain),
  edge.color = c("black", "red")[crossing(resultsLouvain, articlesIgraph) + 1]
)